# 🀄 六华 (Rikka) - 移动端网页版

> **核心规则基准 (Source of Truth)**: 基于官方 PDF 规则文档（含附加规则）。
> **产品定位**: 极致拟物化体验的竖屏移动端桌游。
> **技术架构**: Monorepo (Turborepo) + Next.js 15 (客户端) + Fastify (服务端)。

## 📱 1. 项目概述 (Project Overview)

本项目是桌游《六华》(Rikka) 的数字化实现。核心体验专注于**“指尖的物理感”**——通过细腻的动画、触觉反馈 (Haptics) 和乐观 UI 更新，在手机屏幕上还原真实的搓牌体验。

### 技术栈 (Tech Stack)

* **管理**: `pnpm` + `Turborepo`
* **前端**: `apps/client`
  * Next.js 15 (App Router)
  * Tailwind CSS (Styling)
  * Framer Motion (复杂交互动画)
  * Zustand + Immer (状态管理)
  * `navigator.vibrate` (触觉反馈)
* **后端**: `apps/server`
  * Fastify (高性能 HTTP 服务)
  * Socket.io (实时双向通信)
  * Zod (运行时类型校验)
* **共享**: `packages/shared` (纯 TypeScript 逻辑、类型、常量)

### 开发铁律 (Development Standards)

1.  **零 `any` 容忍**: 严禁使用 `any`。所有数据交互必须经过 Zod Schema 校验。
2.  **移动端优先**: 仅针对竖屏 (Portrait) 设计。触摸热区 > 44px。
3.  **文件原子化**: 单个文件限制最大 **350 行**。组件逻辑过于复杂必须拆分。
4.  **原子提交**: 每完成 Task List 中的一个小项，必须生成一次 Git Commit。

---

## 🎨 2. UI 设计体系与原型 (Design System & Prototypes)

### 2.1 视觉风格指南 (Visual Style Guide)

* **整体氛围**: 沉浸式拟物风格 (Skeuomorphism)，拒绝扁平化。
* **配色方案**:
  * **牌桌背景**: 深绿色毛毡色 (`#1a472a`)，需叠加细微的噪点纹理 (Noise Texture) 以模拟真实质感。
  * **牌面背景**: 米白色 (`#fdfbf7`)，避免使用纯白 (`#ffffff`) 以减少刺眼感。
  * **高亮色**: 金色 (`#fbbf24`) 用于胡牌/胜利；鲜红 (`#ef4444`) 用于重要提示。
* **卡牌质感 (Card Physics)**:
  * 必须有厚度感。使用多层阴影模拟。
  * *Tailwind 示例*: `shadow-[0_2px_0_#ccc,0_4px_6px_rgba(0,0,0,0.3)]` (底部硬阴影模拟厚度，扩散阴影模拟浮空)。
* **动画 (Motion)**:
  * 使用 **Framer Motion**。
  * 发牌、理牌、出牌必须使用 `layoutId` 实现平滑的物理移动，禁止生硬的 DOM 闪烁。

### 2.2 界面原型 (Wireframes)

#### A. 首页大厅 (Lobby)

*风格: 现代、干净、Shadcn UI 风格。*

```text
+------------------------------------------------------+
|  [Avatar]  Hylas                  💎 1280 pts         | <-- 头部信息
+======================================================+
|  🟢 在线: 1,024                                       |
+------------------------------------------------------+
|  房间列表 (ScrollArea)                                |
|  +------------------------------------------------+  |
|  | #1001 🀄 极速场 (2/4)              [🟢 加入] |  | <-- 绿色 Badge
|  +------------------------------------------------+  |
|  +------------------------------------------------+  |
|  | #1002 🏆 进阶场 (4/4)              [⚪ 满员] |  | <-- 灰色 Badge
|  +------------------------------------------------+  |
+======================================================+
|  [ 📜 规则 (Dialog) ]      [ ⚙️ 设置 ]                |
+------------------------------------------------------+
|        [ ➕ 创建房间 (Primary Button, Large) ]        | <-- 底部固定 CTA
+------------------------------------------------------+
```

#### B. 游戏房间 (Game Room)

*风格: 拟物化、深绿色毛毡背景、沉浸式。*

Plaintext

```
+------------------------------------------------------+
| < 退出      房间 #1001       🔊On      📶 24ms      |
+------------------------------------------------------+
| [对手区域] (Avatar, Name, Score)                      |
|   Leo($500)     Sarah($1200)💥     Mike($800)        |
|   🎴x5          🎴x6(Turn)         🎴x5             | <-- 显示牌背数量
+------------------------------------------------------+
| [牌桌区域] (深绿毛毡背景 + 噪点纹理)                    |
|       [ 牌库 Deck ] (3D堆叠厚度)                      |
|       +=====+                                        |
|       |=====| (32)                                   |
|       +=====+                                        |
|                                                      |
|       [ 弃牌堆 Discard ] (散落排列)                   |
|       +---+ +---+                                    |
|       | 5 | | 2 |   +===+                            |
|       +---+ +---+   | 6 | <-- 最新弃牌 (高亮悬浮)     |
|                     +===+                            |
+======================================================+
| [玩家手牌] (Fixed Bottom)                             |
|        [ 🔃 Sort ]   [ 🧨 Riichi ] (悬浮操作栏)       |
|  +=====+ +=====+ +=====+ +=====+ +=====+ +=====+     |
|  |  R  | |  B  | |  G  | |  R  | |  B  | |  R  |     | <-- Top(灰色倒置)
|  |-----| |-----| |-----| |-----| |-----| |-----|     |
|  | Ɫ ꓤ | | Ɛ ꓭ | | S ⅁ | | 9 ꓤ | | ᄅ ꓭ | | ᔭ ꓤ |     | <-- Active(高亮)
|  +=====+ +=====+ +=====+ +=====+ +=====+ +=====+     |
|     👆 点击翻转 (3D Flip)    👆 拖拽出牌 (Drag)        |
+------------------------------------------------------+
```

------

## 📜 3. 官方游戏规则 (完整版)

### 3.1 核心流程

游戏按顺时针进行。轮到玩家时：

1. **摸牌 (Draw)**: 强制从牌库摸 1 张。**严禁**吃/碰弃牌（除非是为了 Ron）。
2. **行动 (Action)**:
   - **翻转 (Flip)**: 自由旋转手牌 (180°)，交换 Top/Bottom 数值。
   - **立直 (Riichi)**: 听牌时可宣告。胡牌 +1 分。代价是手牌锁定（摸牌不胡即打）。
3. **打牌 (Discard)**: 打出 1 张牌。

### 3.2 获胜条件 (役种 Yaku)

手牌 6 张（5+1）根据**下方 (Active) 数值**组成：

- **一色 (Isshiki)** [1分]: 同花色/图案。
- **三连 (Sanren)** [3分]: 两组 3 张连续数字。
- **六华 (Rikka)** [6分]: 特定高难度一色。
- **三对 (Three Pairs)** [5分]: 3 对完全相同的牌。
- **无双 (Musou)** [9分]: 特殊非对称结构。
- **三色 (Sanshiki)** [3分]: 3 种颜色 (仅限过路胡)。
- **辉光纪行 (All Sparkles)** [5分]: 6 张牌全带闪光。

### 3.3 互动机制

- **直击 (Ron)**: 对手弃牌若能让你胡，可立即抢牌。
- **过路胡 (Pass Completion)**: 桌面明牌若能让你胡，可借此胡牌。

------

## 🛠️ 4. 工程与体验优化

1. **乐观 UI (Optimistic UI)**: 点击翻牌/出牌时，立即执行本地动画，不等待服务器响应。
2. **触觉反馈 (Haptics)**: 利用 `navigator.vibrate`。拖拽(5ms)，出牌(15ms)，胡牌(强震动)。
3. **PWA**: 配置 `manifest.json` 为 `standalone` 模式，隐藏浏览器 UI。
4. **断线重连**: Socket 断开时不踢出用户，重连后自动 `SYNC_STATE` 恢复盘面。

------

## ✅ 5. 开发任务清单 (Task List)

> **给 AI 的指令**: 请严格按顺序执行。每完成列表中的**一项**，必须停止并提交 Commit。

### Phase 1: 核心逻辑 (Shared Logic)

- [ ] **1.1 Types**: 定义 `Card`, `Player`, `RoomInfo`, `Yaku`, `GameState`。
- [ ] **1.2 Algorithm**: 实现 `checkWin(cards)`。需支持 `isFlipped` 状态及所有特殊役种。
- [ ] **1.3 Scoring**: 实现 `calculateScore` (含闪光/立直奖励)。

### Phase 2: 服务端实现 (Fastify Server)

- [ ] **2.1 Room Manager**: 管理 `deck`, `discardPile`, `players`。
- [ ] **2.2 Game Loop**: 实现 `DRAW`, `DISCARD`, `FLIP` 处理器。
- [ ] **2.3 Special Actions**: 实现 `RIICHI` (锁定) 和 `RESHUFFLE` (洗牌)。
- [ ] **2.4 Interruption**: 实现 `Ron` 的拦截与判定广播。

### Phase 3: 客户端基础 (Next.js Client)

- [ ] **3.1 Mock Data**: 创建用于 UI 开发的 Mock State。
- [ ] **3.2 Lobby UI**: 实现大厅列表、创建房间、规则弹窗。
- [ ] **3.3 Game Layout**: 实现三段式布局骨架 (参照原型图)。

### Phase 4: 客户端交互与打磨 (Polishing)

- [ ] **4.1 Card Component**: 实现拟物化样式 (Shadows) 和 3D 翻转动画。
- [ ] **4.2 Interaction**: 实现拖拽出牌 (`Drag controls`) 和 动态操作栏。
- [ ] **4.3 Integration**: 对接真实 Socket API。
- [ ] **4.4 UX**: 添加触觉反馈 (Haptics) 和 音效。

------

## 🚀 快速开始

1. `pnpm install`
2. `pnpm dev` (Client: 3000, Server: 4000)